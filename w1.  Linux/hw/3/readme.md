### Упражнение 3*.

Выясните, что происходит с файлами, открытыми в процессе, когда данный процесс вызывает системный вызов fork()?


### Ответ

Ответ на этот вопрос найден https://www.ibm.com/developerworks/ru/library/au-unixprocess/

>Когда процесс дублируется, ядро создает копии всех дескрипторов открытых файлов. 
>Дескриптор файла - это целое число, которое является ссылкой на открытый файл или 
>устройство, и используется для чтения и записи. Если открытие файла находится 
>в программе перед fork, то что произойдет, если оба процесса попытаются читать
>или записывать? Перезапишет один из процессов данные другого? Будут прочитаны 
>две копии файла? Эти вопросы изучаются в листинге  ниже, посредством открытия двух 
>файлов - одного для чтения, другого для записи, а также при помощи одновременного 
>чтения и записи родителем и потомком. 

```
#include <stdio.h>
#include <strings.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
 
int main(void) {
 
        int fd_in,  fd_out;
        char buf[1024];
 
        memset(buf,  0,  1024); /* пустой буфер*/
        fd_in = open("/tmp/infile",  O_RDONLY);
        fd_out = open("/tmp/outfile",  O_WRONLY|O_CREAT);
 
        fork(); /* Потомок против родителя значения не имеет */
 
        while (read(fd_in,  buf,  2) > 0) { /* Цикл через infile */
                printf("%d: %s",  getpid(),  buf);
                /* Написать строку */
                sprintf(buf,  "%d Hello,  world!\n\r",  getpid());
                write(fd_out,  buf,  strlen(buf));
                sleep(1);
                memset(buf,  0,  1024); /* пустой буфер*/
        }
        sleep(10);
}
 
sunbox$ gcc fdtest1.c -o fdtest1
sunbox$ ./fdtest1
2875: 1
2874: 2
2875: 3
2874: 4
2875: 5
2874: 6
2874: 7
sunbox$ cat /tmp/outfile
2875 Hello, world!
2874 Hello, world!
2875 Hello, world!
2874 Hello, world!
2875 Hello, world!
2874 Hello, world!
2874 Hello, world!
```

> Это простая программа, открывающая файл и вызывающая fork. Каждый процесс 
>использует для чтения один и тот же дескриптор файла (это просто текстовый 
>файл с числами от 1 до 7), печатая то, что было прочитано вместе с PID. 
>После прочтения строки PID записывается в выходной файл (out file). 
>Цикл завершается, когда в файле больше не остается непрочитанных символов.
>Результаты работы кода листинга показывают, что, таким образом, **когда один 
>процесс читает из файла, указатель файла смещается для обоих процессов. Также, 
>когда файл записывается, каждый следующий символ добавляется в конец файла. 
>Это имеет смысл, поскольку ядро отслеживает информацию об открытом файле.** 
>Дескриптор файла это просто идентификатор для процесса.
>Cтандартный вывод (экран) тоже имеет дескриптор файла. Это видно во время 
>вызова fork: оба процесса могут выводить информацию на экран.


